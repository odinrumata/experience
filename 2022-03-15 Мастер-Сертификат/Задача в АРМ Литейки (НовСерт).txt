# Доработка АРМ Литейки (НовСерт)

### Cоздание нового типа документа, объединяющего различные схемы контроля

| Изменения | Статус | Комментарий |
| --- | --- | --- |
| 20.03.2022 | Dev review |     |
| 22.03.2022 | Черновик | описаны проблема, концепция решения, |
| 23.03.2022 | Черновик |     |

## Определения и сокращения

| Термин или аббревиатура | Определение |
| --- | --- |
| **Мастер-сертификат (МС)** | Тип виртуального документа, содержащий ссылки и объединяющий в себе документы действующего типа **Сертификат**. Табличная часть МС полностью собирается из табличной части дочерних документов. |
| **Сертификат** | тип электронного документа в МЕС, который служит для официальным подтверждением качества и состава продукции |
| **СхК** | Схема контроля, параметр готовой продукции включающий в т.ч. показатель качества металла. Здесь участвует как атрибут Сертификата (находится в шапке док-та) и как атрибут позиции МС (в табличной части) |
| -   |     |

* * *

## Описание проблемы

Реализация продукция должна сопровождаться бумажным документом с описанием её свойств,хим.состава. Для этого Сотрудник оформляет в МЕС документы вида **Сертификат**. Сотрудник создаёт и проводит документ, распечатывает и отправляет покупателю.

Сейчас в МЕС по каждой схеме контроля создаётся отдельный Сертификат. Но в сертификате на **жидкий металл** допускается объединение продукции разных **СхК**. Если доработать МЕС под этот вариант, можно будет вести учёт одного общего документа вместо десятка, как сейчас. Что упростит работу с сертификатами, сэкономит ресурсы.

### Ожидаемый результат

После доработки можно будет создавать и печатать документ нового типа: **Мастер-Сертификат** (МС), с отдельным значением *Код схемы контроля* в его строках. МС сможет иметь статусы и поддерживаются те же операции что и для существующего типа Сертификат. Для печати МС предусмотрен отдельный шаблон. Операции с прежними сертификатами работают, поддерживаются без изменений.

* * *

## Концепция решения

### Мастер-сертификат, состоит из дочерних Сертификатов

Чтобы не повредить устоявшуюся схему работы принято решение оставить неизменным тип **Сертификат** и операции с ним. Дополнительно следует создать отдельный тип документа **Мастер-сертификат**. Действующий сейчас тип Сертификат остается без изменений, также как его операции и статусы. МС целиком состоит из документов Сертификат и только из них. Для обеспечения консистентности данных Мастер-сертификат (МС) содержит только ссылки на дочерние Сертификата, и не имеет своих позиций.
В шапке документа **МС** храним типичную информацию = ID,дата,user итд В ссылочной таблице (*DOCLINK?*) сохраняем связи документа (родительский) **МС** и **Сертификат** (дочерний) указывают FK на ID дочернего сертификата *(см.диаграмму ниже)*

![7c85187d0237f8d6a54859c6330895fb.png](:/b2fadd8530ae4f06a96a50c6b1d96000)

* * *

## Пользовательские сценарии

### Диаграмма сценариев

![d7662bf42e1834a24d87de22beacb4e7.png](:/5fc8485ec1d042aeada55fd4f910b4c2)

#### Cц 1: Создать новый сертификат

#### Роли:

Сотрудник (Старший кладовщик?), Система

#### Цель:

Сотруднику нужно создать и распечатать сертификат с номенклатурой различных схем контроля

#### Предусловия:

- У Сотрудника есть нужные права и полномочия для операций
- Сотрудник залогинен в МЕС, открыт АРМа
- В системе есть остатки номенклатуры жидкого металла

#### Шаги сценария (порядок действий)

1.  Сотрудник выбирает команду "Создать документ" вида **Сертификат**
2.  `(backend)` Система выбирает остатки продукции, `(frontend)` и отображает их в левой части экрана; черновик документа *(его начальную форму)* \- в правой части
3.  Сотрудник вводит известный ему *номер заказа SAP* на форме черновика (в правой части)
4.  `(backend)` Система вызывает `API интеграции/кэша SAP`, передаёт *номер заказа*, получает документ заказа в виде `XML`
5.  Сотрудник помечает \[ x \] строки товарных остатков, нажимает "Добавить"
6.  Система переносит выбранные позиции в черновик документа. `frontend` Динамически скрывает строки в левой и отображает их в правой части экрана
7.  Сотрудник проверяет документ.
    Он может выделить строку чтобы вынести её из документа
    7.1 Тогда Система убирает соотв.запись из черновика, обновляет форму - строка появляется в таблицу левой части экрана
8.  Сотрудник выбирает действие для документа "Сохранить и провести"
9.  Система проверяет данные документа
10. Система сохраняет документ, его "шапку" и "табличную часть"
11. Система группирует позиции документа с одинаковым значением атрибута "схема контроля". В цикле создаёт стандартные документы-сертификаты по действующим в текущей реализации правилам. Создается *n* документов = кол\-ву групп. Создается запись в БД \- строка атрибутов шапки документа. Создаются ссылки на дочерние доекменты-сертификаты 11b. `МАСТЕР-СЕРТИФИКАТ`
    Система группирует позиции документа по атрибуту "" создаёт стандартные сертификаты, по действующим, непротиворечивым текущей реализации правилам группировки позиций документа. При этом каждому такому документу присваивает печатный номер группы вида **XXXXXX-YY**

* * *

Сотрудник создаёт новый Мастер-Сертификат. Заполняет данными, завершает оформление, отправляет контрагенту

## Альтернативные сценарии

**Cц 1-1**: Сотрудник сохраняет черновик док-та, операции перемещения не создаются Сотрудник сохраняет черновик документа чтобы вернуться к нему позже. Операции не создаются, документ в статусе черновика.

**Cц 1-2**: Сотрудник обновляет Мастер-Сертификат данными связанного заказа из SAP Сотрудник открывает сохранённый черновик МС. Нажимает кнопку для получения недостающих данных из SAP. Система выбирает данные и документ МС обновляется.

**Cц 1-3**: Сотрудник проводит МС, формируются операции перемещения Сотрудник открывает сохранённый черновик МС.Проверяет данные, нажимает сохранить док-т, произвести операции перемещения, распечатать сводный сертификат

**Cц 1-4**: Система создаёт группу дочерних документов Сертификатов. Система автоматически группирует записи по заданным условиям.По каждой группе генерирует отдельный Сертификат. Создаёт привязку таких дочерних документов к одному общему док-ту, чтобы распечатать в едином шаблоне. Обновляет статусы родительского дочерних документов. *(в системе можно реализовать чтобы дочки получали наследуемый статус. Вычисляемое поле по статусу родителя)*

Cц 1-7: Нет данных по указанному номеру заказа Cц 1-7а: Нет номера заказа и/или `XML` в момент сохранении Cц 1-8: Сотрудник меняет номер заказа, a `XML` уже была привязана Cц 1-6: Система при сохранении заново получает XML и\\или проверяет что там не было изменений

* * *

### Прочие требования, задачи

**Серт-01** В любом из вариантов поребуется реализовать отдельную печатную форму нового вида сертификата.

**Серт-02** Создать ряд проверок на ограничение действий с сертификатом, который является элементом группы. Вычисление статуса дочернего документа из статуса родительского **МС**

Печатная форма нового Сертификата

Документ делится на 2 части, ![f39e014e8df659db7d0816204d731c46.png](:/369060859778498e9784d99545d1d8ed)

- 1-я часть, формат А4 в книжной ориентации, содержит
    - таблицу с номенклатурой
    - в которой добавлена колонка "Марка"

![fab6997a2e38a6bfb781a1b040b6d29d.png](:/6a0231b0a22247e2923fa2a4d1271cb1)

- 2-я часть, формат А4 в альбомной ориентации, содержит хим.состав со значениями по отдельным элементам в колонках таблицы

* * *

### Отклоненные варианты реализации

#### (B) МС как псевдо-документ

Можно и шапку документа не хранить, а тоже генерировать "на лету". Т.е. на `backend` SQL-запросом собирать виртуальный документ из группы обычных сертификатов (как работает представление - view) и передавать его в АРМ. Для признака "сертификат входит в группу" создать отдельное поле, или использовать поле печатного номера (не ID). Определить что формат такого номера **XXXXXX-YY**, где **XXXXXX** \- префикс, единый номер группы, по которому и производить выборку "дочек" **YY** \- порядковый номер сертификата в группе, от 01 до 99 *вероятно* что такой вариант окажется проще в реализации и поддержке.

* * *

### (C) Изменить структуру БД

[5a667cbf3e41b650658522efa59192ea.png](:/7df0193668f6450aa18c3444c629c46d)

1.  Изменить таблицы XFOUNDRY\_CERTIFICATE и XFOUNDRY\_CERTIFICATEROW , сделать перетасовку аттрибутов между ними, минимально это перенести поле "ID схемы контроля" (ID\_CTRL\_SCH) из шапочной части в табличную. Тогда будет возможным создавать документ с разной номенклатурой (как сейчас) + разными схемами контроля.
2.  Изменить привязку FK XFOUNDRY.CTRL_SCH к записям табличной части (убрав из шапки)
3.  Переименовать таблицы, создать view с прежними названиями таблиц, который будет возвращать данные в старой структуре. Так все имеющиеся запросы к таблице XFOUNDRY_CERTIFICATE продолжат работать без внесения изменений.
4.  На форме АРМ потребуются доработки для ветвления при распечатке и др.
5.  Изменений и рисков минимум, а профит тот же, а требования будут удовлетворены

